#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¤§å‹æ–‡æœ¬èªæ„åˆ†æ®µæ¸¬è©¦
"""

import os
import sys
import logging

# æ·»åŠ å°ˆæ¡ˆæ ¹ç›®éŒ„åˆ°è·¯å¾‘
project_root = os.path.abspath(os.path.dirname(__file__))
sys.path.insert(0, project_root)

def test_large_text_segmentation():
    """æ¸¬è©¦å¤§å‹æ–‡æœ¬çš„èªæ„åˆ†æ®µåŠŸèƒ½"""
    logging.basicConfig(level=logging.INFO, format='[%(asctime)s] [%(levelname)s] %(message)s')
    logger = logging.getLogger(__name__)
    
    # å‰µå»ºå¤§å‹æ¸¬è©¦æ–‡æœ¬ï¼ˆè¶…é4000å­—å…ƒï¼‰
    large_text = """
    ä»Šå¤©çš„è‘£äº‹æœƒæœƒè­°éå¸¸é‡è¦ï¼Œè¨è«–äº†å…¬å¸æœªä¾†ä¸€å¹´çš„æˆ°ç•¥è¦åŠƒå’Œé‡è¦æ±ºç­–ã€‚
    
    é¦–å…ˆï¼ŒCEOåŒ¯å ±äº†ç¬¬ä¸‰å­£åº¦çš„è²¡å‹™è¡¨ç¾ã€‚ç‡Ÿæ”¶é”åˆ°äº†é æœŸç›®æ¨™çš„105%ï¼Œæ·¨åˆ©æ½¤åŒæ¯”å¢é•·äº†18%ã€‚
    é€™ä¸»è¦æ­¸åŠŸæ–¼æ–°ç”¢å“ç·šçš„æˆåŠŸæ¨å‡ºå’Œå¸‚å ´ä»½é¡çš„ç©©æ­¥æ“´å¼µã€‚ç‰¹åˆ¥æ˜¯åœ¨äºå¤ªå¸‚å ´ï¼Œ
    æˆ‘å€‘çš„æ¥­å‹™å¢é•·äº†25%ï¼Œè¶…å‡ºäº†æ‰€æœ‰é æœŸã€‚
    
    æ¥ä¸‹ä¾†ï¼ŒæŠ€è¡“ç¸½ç›£è©³ç´°ä»‹ç´¹äº†æ­£åœ¨é€²è¡Œçš„æ•¸ä½è½‰å‹è¨ˆç•«ã€‚è©²è¨ˆç•«é è¨ˆæŠ•è³‡2000è¬å…ƒï¼Œ
    æ—¨åœ¨å‡ç´šæˆ‘å€‘çš„ITåŸºç¤è¨­æ–½å’Œå®¢æˆ¶æœå‹™ç³»çµ±ã€‚é è¨ˆé€™é …æŠ•è³‡å°‡åœ¨æœªä¾†ä¸‰å¹´å…§
    å¸¶ä¾†é¡¯è‘—çš„æ•ˆç‡æå‡å’Œæˆæœ¬ç¯€ç´„ã€‚è‘£äº‹æœƒä¸€è‡´åŒæ„æ¨é€²é€™å€‹è¨ˆç•«ã€‚
    
    äººåŠ›è³‡æºç¸½ç›£ä¹Ÿæå‡ºäº†äººæ‰ç™¼å±•æˆ°ç•¥ã€‚å…¬å¸è¨ˆåŠƒåœ¨æœªä¾†å…­å€‹æœˆå…§æ‹›è˜100åæ–°å“¡å·¥ï¼Œ
    ä¸»è¦é›†ä¸­åœ¨ç ”ç™¼ã€éŠ·å”®å’Œå®¢æˆ¶æœå‹™éƒ¨é–€ã€‚åŒæ™‚ï¼Œæˆ‘å€‘ä¹Ÿå°‡æ¨å‡ºæ–°çš„å“¡å·¥åŸ¹è¨“è¨ˆç•«ï¼Œ
    ç¢ºä¿æ‰€æœ‰å“¡å·¥éƒ½èƒ½è·Ÿä¸Šå…¬å¸å¿«é€Ÿç™¼å±•çš„æ­¥ä¼ã€‚
    
    å¸‚å ´ç¸½ç›£å ±å‘Šäº†å³å°‡æ¨å‡ºçš„æ–°ç”¢å“è¨ˆç•«ã€‚æˆ‘å€‘é è¨ˆåœ¨ä¸‹å­£åº¦æ¨å‡ºä¸‰æ¬¾æ–°ç”¢å“ï¼Œ
    é€™äº›ç”¢å“å·²ç¶“é€šéäº†æ‰€æœ‰å¿…è¦çš„æ¸¬è©¦å’Œèªè­‰ã€‚åˆæ­¥çš„å¸‚å ´èª¿ç ”é¡¯ç¤ºï¼Œ
    é€™äº›ç”¢å“æœ‰å¾ˆå¤§çš„å¸‚å ´æ½›åŠ›ï¼Œé è¨ˆå°‡ç‚ºå…¬å¸å¸¶ä¾†é¡å¤–çš„ç‡Ÿæ”¶å¢é•·ã€‚
    
    è²¡å‹™ç¸½ç›£è©³ç´°åˆ†æäº†å…¬å¸çš„è³‡é‡‘ç‹€æ³å’ŒæŠ•è³‡è¨ˆç•«ã€‚ç›®å‰å…¬å¸çš„ç¾é‡‘æµç‹€æ³è‰¯å¥½ï¼Œ
    å‚µå‹™æ°´å¹³æ§åˆ¶åœ¨åˆç†ç¯„åœå…§ã€‚è‘£äº‹æœƒæ‰¹å‡†äº†ä¸€é …æ–°çš„æŠ•è³‡è¨ˆç•«ï¼Œ
    å°‡æŠ•è³‡3000è¬å…ƒç”¨æ–¼æ“´å»ºç”Ÿç”¢è¨­æ–½å’Œè³¼è²·æ–°è¨­å‚™ã€‚
    
    æ³•å‹™éƒ¨é–€ä¹Ÿæäº¤äº†é—œæ–¼åˆè¦å’Œé¢¨éšªç®¡ç†çš„å ±å‘Šã€‚éš¨è‘—æ¥­å‹™è¦æ¨¡çš„æ“´å¤§ï¼Œ
    æˆ‘å€‘éœ€è¦åŠ å¼·åˆè¦ç®¡ç†ï¼Œç¢ºä¿æ‰€æœ‰æ¥­å‹™æ´»å‹•éƒ½ç¬¦åˆç›¸é—œæ³•è¦è¦æ±‚ã€‚
    è‘£äº‹æœƒåŒæ„å¢åŠ æ³•å‹™éƒ¨é–€çš„äººå“¡é…ç½®ï¼Œä¸¦æŠ•è³‡æ–°çš„åˆè¦ç®¡ç†ç³»çµ±ã€‚
    
    æœ€å¾Œï¼Œè‘£äº‹æœƒè¨è«–äº†å…¬å¸çš„å¯æŒçºŒç™¼å±•æˆ°ç•¥ã€‚æˆ‘å€‘æ‰¿è«¾åœ¨2030å¹´å‰å¯¦ç¾ç¢³ä¸­å’Œï¼Œ
    é€™éœ€è¦å¤§é‡çš„æŠ•è³‡å’ŒæŠ€è¡“å‰µæ–°ã€‚è‘£äº‹æœƒå·²ç¶“æ‰¹å‡†äº†ç›¸é—œçš„ç ”ç™¼é ç®—ï¼Œ
    ä¸¦å»ºç«‹äº†å°ˆé–€çš„å¯æŒçºŒç™¼å±•å§”å“¡æœƒä¾†æ¨é€²é€™é …å·¥ä½œã€‚
    
    æœƒè­°é‚„è¨è«–äº†è‚¡æ±å›å ±æ”¿ç­–ã€‚è€ƒæ…®åˆ°å…¬å¸è‰¯å¥½çš„è²¡å‹™è¡¨ç¾ï¼Œ
    è‘£äº‹æœƒæ±ºå®šå¢åŠ è‚¡æ¯æ´¾ç™¼ï¼Œæ¯è‚¡æ´¾æ¯0.5å…ƒï¼Œæ¯”å»å¹´å¢é•·äº†25%ã€‚
    é€™é¡¯ç¤ºäº†è‘£äº‹æœƒå°å…¬å¸æœªä¾†ç™¼å±•çš„ä¿¡å¿ƒã€‚
    
    åœ¨ç«¶çˆ­åˆ†ææ–¹é¢ï¼Œå¸‚å ´ç ”ç©¶åœ˜éšŠæä¾›äº†è©³ç´°çš„ç«¶çˆ­å°æ‰‹åˆ†æå ±å‘Šã€‚
    æˆ‘å€‘åœ¨å¸‚å ´ä¸Šçš„ä½ç½®ä¾ç„¶å¼·å‹ï¼Œä½†ä¹Ÿé¢è‡¨ä¸€äº›æ–°çš„æŒ‘æˆ°ã€‚
    ç‚ºäº†ä¿æŒç«¶çˆ­å„ªå‹¢ï¼Œæˆ‘å€‘éœ€è¦ç¹¼çºŒæŠ•è³‡ç ”ç™¼å’Œå‰µæ–°ã€‚
    """ * 10  # é‡è¤‡10æ¬¡ä»¥å‰µå»ºè¶…å¤§æ–‡æœ¬
    
    logger.info(f"æ¸¬è©¦æ–‡æœ¬é•·åº¦: {len(large_text)} å­—å…ƒ")
    
    try:
        from scripts.optimize_meeting_minutes import MeetingOptimizer
        
        optimizer = MeetingOptimizer(
            model_name="cwchang/llama3-taide-lx-8b-chat-alpha1:latest",
            enable_semantic_segmentation=True
        )
        
        # æ¸¬è©¦åˆ†æ®µåŠŸèƒ½
        result = optimizer._check_and_segment_transcript(large_text)
        
        if isinstance(result, list) and len(result) > 1:
            logger.info(f"âœ… èªæ„åˆ†æ®µæˆåŠŸè§¸ç™¼ï¼åˆ†æˆ {len(result)} å€‹ç‰‡æ®µ")
            
            # é¡¯ç¤ºæ¯å€‹ç‰‡æ®µçš„é•·åº¦çµ±è¨ˆ
            for i, segment in enumerate(result):
                logger.info(f"  ç‰‡æ®µ {i+1}: {len(segment)} å­—å…ƒ")
                
            # é¡¯ç¤ºåˆ†æ®µå“è³ª
            total_chars = sum(len(seg) for seg in result)
            logger.info(f"åŸå§‹æ–‡æœ¬: {len(large_text)} å­—å…ƒ")
            logger.info(f"åˆ†æ®µå¾Œç¸½è¨ˆ: {total_chars} å­—å…ƒ")
            logger.info(f"å­—å…ƒä¿æŒç‡: {total_chars/len(large_text)*100:.1f}%")
            
        else:
            logger.warning("âŒ èªæ„åˆ†æ®µæœªè¢«è§¸ç™¼ï¼Œå¯èƒ½é–¾å€¼è¨­ç½®æœ‰å•é¡Œ")
            
        assert True
        
    except Exception as e:
        logger.error(f"âŒ æ¸¬è©¦å¤±æ•—: {e}")
        assert False

if __name__ == "__main__":
    success = test_large_text_segmentation()
    print(f"\n{'='*50}")
    if success:
        print("ğŸ‰ å¤§å‹æ–‡æœ¬èªæ„åˆ†æ®µæ¸¬è©¦å®Œæˆ")
    else:
        print("âŒ å¤§å‹æ–‡æœ¬èªæ„åˆ†æ®µæ¸¬è©¦å¤±æ•—")
    print(f"{'='*50}")
